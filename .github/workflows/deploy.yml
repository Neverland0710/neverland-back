name: ğŸš€ Deploy to EC2 with Docker Compose

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v3

      - name: ğŸš€ Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # ğŸ‘‰ ì‘ì—… ë””ë ‰í† ë¦¬ ì´ë™
            cd ~/app

            # ğŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ë° ì •ë¦¬
            docker-compose down || true
            docker system prune -f

            # ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            rm -rf spring-server
            git clone https://github.com/Neverland0710/neverland-back.git spring-server

            # âœ… .env ìƒì„±
            cat > .env << 'ENV_EOF'
            DB_URL=${{ secrets.DB_URL }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
            SERVER_PORT=8086
            SPRING_PROFILES_ACTIVE=prod
            FIREBASE_CONFIG_JSON=classpath:firebase_adminsdk.json
            ENV_EOF

            # âœ… Firebase Admin SDK JSON íŒŒì¼ ë³µì›
            mkdir -p spring-server/src/main/resources
            echo "${{ secrets.FIREBASE_CONFIG_JSON_BASE64 }}" | base64 -d > spring-server/src/main/resources/firebase_adminsdk.json

            # ğŸ³ Docker Compose ì‹¤í–‰
            echo "ğŸ”¨ Building application..."
            docker-compose build --no-cache

            echo "ğŸš€ Starting application..."
            docker-compose up -d

            echo "â³ Waiting for application to start..."
            sleep 30

            echo "ğŸ“Š Deployment Status:"
            docker-compose ps

            echo "ğŸ“‹ Application Logs:"
            docker-compose logs spring-server --tail 10

            echo "ğŸ¥ Health Check:"
            curl -f http://localhost:8086/actuator/health || echo "âŒ Health check failed"

            echo "âœ… Deployment completed!"
