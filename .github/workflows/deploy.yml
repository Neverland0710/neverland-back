name: ğŸ³ Deploy Spring Boot with Docker to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ—ï¸ Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: ğŸ“¡ Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~
          
            # ê¸°ì¡´ í´ë” ì •ë¦¬
            rm -rf app
          
            # GitHubì—ì„œ ì½”ë“œ ë°›ì•„ì˜¤ê¸°
            git clone https://github.com/Neverland0710/neverland-back.git app
            cd app
          
            # Java 17 ì„¤ì¹˜ (ë§Œì•½ ì—†ë‹¤ë©´)
            sudo apt update
            sudo apt install -y openjdk-17-jdk
          
            # Gradle ë¹Œë“œ
            chmod +x ./gradlew
            ./gradlew clean build -x test
          
            # Docker ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker stop spring-server || true
            docker rm spring-server || true
          
            # Dockerfile ìƒì„± (JAR íŒŒì¼ ê²½ë¡œ ë§ì¶¤)
            cat > Dockerfile << 'DOCKEREOF'
          FROM openjdk:17-jdk-slim
          WORKDIR /app
          COPY build/libs/*.jar app.jar
          EXPOSE 8086
          ENTRYPOINT ["java", "-jar", "app.jar"]
          DOCKEREOF
          
            # Docker ë¹Œë“œ ë° ì‹¤í–‰
            docker build -t spring-app .
          
            docker run -d \
              --name spring-server \
              -p 8086:8086 \
              -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
              -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
              -e AWS_REGION="${{ secrets.AWS_REGION }}" \
              -e S3_BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}" \
              -e DB_URL="${{ secrets.DB_URL }}" \
              -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
              -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              -e FIREBASE_CONFIG_JSON="${{ secrets.FIREBASE_CONFIG_JSON }}" \
              -e SERVER_PORT=8086 \
              -e SPRING_PROFILES_ACTIVE=prod \
              --restart always \
              spring-app
          
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            docker ps | grep spring-server
          EOF