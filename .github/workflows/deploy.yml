name: ğŸ³ Deploy Spring Boot with Docker to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout source
        uses: actions/checkout@v3

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ”¨ Build with Maven
        run: |
          chmod +x ./mvnw
          ./mvnw clean package -DskipTests

      - name: ğŸ—ï¸ Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: ğŸ“ Copy files to EC2
        run: |
          # EC2ì— íŒŒì¼ë“¤ ë³µì‚¬
          scp -o StrictHostKeyChecking=no -r ./target/*.jar ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/app/
          scp -o StrictHostKeyChecking=no ./Dockerfile ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/app/

      - name: ğŸ“¡ Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/app
          
            docker stop spring-server || true
            docker rm spring-server || true
            docker build -t spring-app .
          
            docker run -d \
              --name spring-server \
              -p 8086:8086 \
              -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
              -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
              -e AWS_REGION="${{ secrets.AWS_REGION }}" \
              -e S3_BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}" \
              -e DB_URL="${{ secrets.DB_URL }}" \
              -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
              -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              -e FIREBASE_CONFIG_JSON="${{ secrets.FIREBASE_CONFIG_JSON }}" \
              -e SERVER_PORT=8086 \
              -e SPRING_PROFILES_ACTIVE=prod \
              --restart always \
              spring-app
          EOF