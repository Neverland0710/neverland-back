name: ğŸ³ Deploy Spring Boot with Docker to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout source
        uses: actions/checkout@v3

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ”¨ Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test

      - name: ğŸ—ï¸ Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: ğŸ“¡ Deploy to EC2
        run: |
          # ì „ì²´ í”„ë¡œì íŠ¸ë¥¼ tarë¡œ ì••ì¶•í•´ì„œ í•œ ë²ˆì— ì „ì†¡
          tar -czf project.tar.gz --exclude='.git' --exclude='node_modules' .
          
          scp -o StrictHostKeyChecking=no project.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/
          
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            # ê¸°ì¡´ app í´ë” ì •ë¦¬í•˜ê³  ìƒˆë¡œ ì••ì¶• í•´ì œ
            rm -rf ~/app
            mkdir -p ~/app
            cd ~/app
            tar -xzf ~/project.tar.gz
            rm ~/project.tar.gz
          
            # Docker ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker stop spring-server || true
            docker rm spring-server || true
          
            # Docker ì´ë¯¸ì§€ ë¹Œë“œ
            docker build -t spring-app .
          
            # Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            docker run -d \
              --name spring-server \
              -p 8086:8086 \
              -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
              -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
              -e AWS_REGION="${{ secrets.AWS_REGION }}" \
              -e S3_BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}" \
              -e DB_URL="${{ secrets.DB_URL }}" \
              -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
              -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              -e FIREBASE_CONFIG_JSON="${{ secrets.FIREBASE_CONFIG_JSON }}" \
              -e SERVER_PORT=8086 \
              -e SPRING_PROFILES_ACTIVE=prod \
              --restart always \
              spring-app
          
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            docker ps | grep spring-server
          EOF