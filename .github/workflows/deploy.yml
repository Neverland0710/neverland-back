# .github/workflows/deploy.yml
name: ðŸš€ Deploy to EC2 with Docker Compose

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v3

      - name: ðŸš€ Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # ðŸ“ ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~/app
            
            # ðŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker-compose down || true
            docker system prune -f
            
            # ðŸ“¥ ìµœì‹  ì½”ë“œ ë°›ê¸°
            rm -rf spring-server
            git clone https://github.com/Neverland0710/neverland-back.git spring-server
            
            # ðŸ“„ application.properties ìƒì„± (í™˜ê²½ë³€ìˆ˜ ë°©ì‹)
            mkdir -p spring-server/src/main/resources
            cat > spring-server/src/main/resources/application.properties << 'PROPS_EOF'
            # âœ… DB ì„¤ì • (í™˜ê²½ë³€ìˆ˜ì—ì„œ ì½ìŒ)
            spring.datasource.url=${SPRING_DATASOURCE_URL}
            spring.datasource.username=${SPRING_DATASOURCE_USERNAME}
            spring.datasource.password=${SPRING_DATASOURCE_PASSWORD}
            spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

            # âœ… JPA ì„¤ì •
            spring.jpa.hibernate.ddl-auto=update
            spring.jpa.show-sql=false
            spring.jpa.properties.hibernate.format_sql=true
            spring.jpa.database-platform=org.hibernate.dialect.MySQLDialect
            spring.jpa.hibernate.naming.physical-strategy=org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl

            # âœ… ì •ì  ë¦¬ì†ŒìŠ¤ ë° íŒŒì¼ ì—…ë¡œë“œ ì„¤ì •
            spring.web.resources.static-locations=classpath:/static/images/
            spring.servlet.multipart.max-file-size=20MB
            spring.servlet.multipart.max-request-size=20MB
            spring.datasource.hikari.max-lifetime=1800000
            spring.datasource.hikari.idle-timeout=600000

            # âœ… í¬íŠ¸ ì„¤ì •
            server.port=${SERVER_PORT:8086}
            server.address=0.0.0.0

            # âœ… JWT ì„¤ì • (í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©)
            jwt.secret=${JWT_SECRET}
            jwt.expiration=${JWT_EXPIRATION:3600000}

            # âœ… AWS S3 ì„¤ì •
            cloud.aws.credentials.access-key=${AWS_ACCESS_KEY_ID}
            cloud.aws.credentials.secret-key=${AWS_SECRET_ACCESS_KEY}
            cloud.aws.region.static=${AWS_REGION}
            cloud.aws.s3.bucket=${S3_BUCKET_NAME}
            cloud.aws.stack.auto=false

            # âœ… Firebase ì„¤ì •
            firebase.config-json=classpath:firebase_adminsdk.json

            # âœ… ë¡œê¹…
            logging.level.root=INFO
            logging.level.projcet.neverland=DEBUG

            # âœ… Management ì—”ë“œí¬ì¸íŠ¸
            management.endpoints.web.exposure.include=health,info
            management.endpoint.health.show-details=always
            PROPS_EOF
            
            # ðŸ“„ docker-compose.yml ìƒì„± (ì™„ë²½í•œ í™˜ê²½ë³€ìˆ˜)
            cat > docker-compose.yml << 'YAML_EOF'
            version: '3.8'
            services:
              spring-server:
                build:
                  context: ./spring-server
                ports:
                  - "8086:8086"
                environment:
                  - "SPRING_PROFILES_ACTIVE=prod"
                  - "SPRING_DATASOURCE_URL=${{ secrets.DB_URL }}"
                  - "SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USERNAME }}"
                  - "SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}"
                  - "SPRING_DATASOURCE_DRIVER_CLASS_NAME=com.mysql.cj.jdbc.Driver"
                  - "SERVER_PORT=8086"
                  - "JWT_SECRET=${{ secrets.JWT_SECRET }}"
                  - "JWT_EXPIRATION=3600000"
                  - "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}"
                  - "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}"
                  - "AWS_REGION=${{ secrets.AWS_REGION }}"
                  - "S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}"
                container_name: spring-server
                restart: always
                healthcheck:
                  test: ["CMD-SHELL", "curl -f http://localhost:8086/actuator/health || exit 1"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 60s
            YAML_EOF
            
            # ðŸ³ Docker Compose ì‹¤í–‰
            echo "ðŸ”¨ Building application..."
            docker-compose build --no-cache
            
            echo "ðŸš€ Starting application..."
            docker-compose up -d
            
            # â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œìž‘ ëŒ€ê¸°
            echo "â³ Waiting for application to start..."
            sleep 30
            
            # âœ… ë°°í¬ ìƒíƒœ í™•ì¸
            echo "ðŸ“Š Deployment Status:"
            docker-compose ps
            
            echo "ðŸ“‹ Application Logs:"
            docker-compose logs spring-server --tail 10
            
            # ðŸ¥ í—¬ìŠ¤ì²´í¬
            echo "ðŸ¥ Health Check:"
            curl -f http://localhost:8086/actuator/health || echo "âŒ Health check failed"
            
            echo "âœ… Deployment completed!"