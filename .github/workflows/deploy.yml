name: 🐳 Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Checkout repository
        uses: actions/checkout@v3

      - name: 🚀 Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "✅ 환경 변수 생성 중..."
            cat > /root/neverland/.env <<EOF
  DB_URL="${{ secrets.DB_URL }}"
  DB_USERNAME="${{ secrets.DB_USERNAME }}"
  DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
  JWT_SECRET="${{ secrets.JWT_SECRET }}"
  S3_BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}"
  AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
  AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
  AWS_REGION="${{ secrets.AWS_REGION }}"
  EOF
  
  echo "📁 디렉토리 이동 및 코드 업데이트"
  cd /root/neverland
  git pull origin main
  
  echo "⚙️ 도커 재시작"
  docker compose down
  docker compose up -d --build